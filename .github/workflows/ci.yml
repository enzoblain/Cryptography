name: Cryptography CI

on:
  push:
  pull_request:

jobs:
  build_libs:
    runs-on: ubuntu-latest
    outputs:
      crate-name: ${{ steps.getcrate.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Get crate name
        id: getcrate
        run: |
          NAME=$(grep '^name' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Build default
        run: cargo build --release
      - name: Save default
        run: |
          mkdir -p lib_default
          cp target/release/deps/lib*.rlib lib_default/
      - uses: actions/upload-artifact@v4
        with:
          name: lib_default
          path: lib_default/

      - name: Build speed
        run: cargo build --release --features speed
      - name: Save speed
        run: |
          mkdir -p lib_speed
          cp target/release/deps/lib*.rlib lib_speed/
      - uses: actions/upload-artifact@v4
        with:
          name: lib_speed
          path: lib_speed/

      - name: Build ref
        run: cargo build --release --benches
      - name: Save ref
        run: |
          mkdir -p lib_ref
          cp target/release/deps/lib*.rlib lib_ref/
      - uses: actions/upload-artifact@v4
        with:
          name: lib_ref
          path: lib_ref/

  test_default:
    runs-on: ubuntu-latest
    needs: build_libs
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests
        run: cargo test --verbose

  test_speed:
    runs-on: ubuntu-latest
    needs: build_libs
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests (speed)
        run: cargo test --verbose --features speed

  bench_default:
    runs-on: windows-latest # Switch benchmarks to Windows runners so performance reflects real-world user hardware (no AVX2).
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Classic 256
        run: cargo bench --bench sha256

      - uses: actions/download-artifact@v4
        with:
          name: lib_default
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256/new/estimates.json)
          echo $M > mean.txt

      - name: Extract size
        shell: bash
        run: |
          LIB=$(ls -1t lib/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: classic256
          path: |
            mean.txt
            size.txt

  bench_speed:
    runs-on: windows-latest # Switch benchmarks to Windows runners so performance reflects real-world user hardware (no AVX2).
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Turbo 256
        run: cargo bench --bench sha256 --features speed

      - uses: actions/download-artifact@v4
        with:
          name: lib_speed
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256/new/estimates.json)
          echo $M > mean.txt

      - name: Extract size
        shell: bash
        run: |
          LIB=$(ls -1t lib/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: turbo256
          path: |
            mean.txt
            size.txt

  bench_ref:
    runs-on: windows-latest # Switch benchmarks to Windows runners so performance reflects real-world user hardware (no AVX2).
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Reference 256
        run: cargo bench --bench sha256_ref

      - uses: actions/download-artifact@v4
        with:
          name: lib_ref
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256_ref/new/estimates.json)
          echo $M > mean.txt

      - name: Extract size
        shell: bash
        run: |
          LIB=$(ls -1t lib/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: ref256
          path: |
            mean.txt
            size.txt

  summary:
    runs-on: ubuntu-latest
    needs: [bench_default, bench_speed, bench_ref]
    steps:
      - uses: actions/download-artifact@v4

      - name: Print summary
        run: |
          M_DEF=$(cat classic256/mean.txt)
          S_DEF=$(cat classic256/size.txt)
          M_SPD=$(cat turbo256/mean.txt)
          S_SPD=$(cat turbo256/size.txt)
          M_REF=$(cat ref256/mean.txt)
          S_REF=$(cat ref256/size.txt)

          echo
          echo "=== Performance Summary ==="
          printf "%-20s | %-12s | %-12s\n" "Version" "Speed" "Size"
          printf "%-20s-+-%-12s-+-%-12s\n" "--------------------" "------------" "------------"
          printf "%-20s | %-12s | %-12s\n" "Classic 256" "$M_DEF" "$S_DEF"
          printf "%-20s | %-12s | %-12s\n" "Turbo 256"   "$M_SPD" "$S_SPD"
          printf "%-20s | %-12s | %-12s\n" "Reference 256" "$M_REF" "$S_REF"