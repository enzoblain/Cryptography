name: Cryptography ci

on:
  push:
  pull_request:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      crate-name: ${{ steps.getcrate.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Get crate name
        id: getcrate
        run: |
          NAME=$(grep '^name' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Build release
        run: cargo build --release

      - name: Upload library artifact
        run: |
          CRATE=$(grep '^name' Cargo.toml | head -1 | cut -d'"' -f2)
          LIB=$(ls -1t target/release/deps/lib${CRATE}-*.rlib | head -1)
          mkdir -p artifact_lib
          cp "$LIB" artifact_lib/
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: library
          path: artifact_lib/

  test_default:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests (default)
        run: cargo test --verbose

  test_speed:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests (speed)
        run: cargo test --verbose --features speed

  bench_default:
    runs-on: ubuntu-latest
    needs: [prepare, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Classic 256
        run: cargo bench --bench sha256

      - name: Download library
        uses: actions/download-artifact@v4
        with:
          name: library
          path: libdl

      - name: Extract mean
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256/new/estimates.json)
          echo $M > mean.txt

      - name: Extract lib size
        run: |
          LIB=$(ls -1t libdl/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: classic256
          path: |
            mean.txt
            size.txt

  bench_speed:
    runs-on: ubuntu-latest
    needs: [prepare, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Turbo 256
        run: cargo bench --bench sha256 --features speed

      - name: Download library
        uses: actions/download-artifact@v4
        with:
          name: library
          path: libdl

      - name: Extract mean
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256/new/estimates.json)
          echo $M > mean.txt

      - name: Extract lib size
        run: |
          LIB=$(ls -1t libdl/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: turbo256
          path: |
            mean.txt
            size.txt

  bench_ref:
    runs-on: ubuntu-latest
    needs: [prepare, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Reference 256
        run: cargo bench --bench sha256_ref

      - name: Download library
        uses: actions/download-artifact@v4
        with:
          name: library
          path: libdl

      - name: Extract mean
        run: |
          M=$(jq '.mean.point_estimate' target/criterion/sha256_ref/new/estimates.json)
          echo $M > mean.txt

      - name: Extract lib size
        run: |
          LIB=$(ls -1t libdl/lib*.rlib | head -1)
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: ref256
          path: |
            mean.txt
            size.txt

  summary:
    runs-on: ubuntu-latest
    needs: [bench_default, bench_speed, bench_ref]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Print summary table
        run: |
          M_DEF=$(cat classic256/mean.txt)
          S_DEF=$(cat classic256/size.txt)
          M_SPD=$(cat turbo256/mean.txt)
          S_SPD=$(cat turbo256/size.txt)
          M_REF=$(cat ref256/mean.txt)
          S_REF=$(cat ref256/size.txt)

          echo
          echo "=== Performance Summary ==="
          printf "%-20s | %-12s | %-12s\n" "Version" "Speed" "Size"
          printf "%-20s-+-%-12s-+-%-12s\n" "--------------------" "------------" "------------"
          printf "%-20s | %-12s | %-12s\n" "Classic 256" "$M_DEF" "$S_DEF"
          printf "%-20s | %-12s | %-12s\n" "Turbo 256"   "$M_SPD" "$S_SPD"
          printf "%-20s | %-12s | %-12s\n" "Reference 256" "$M_REF" "$S_REF"